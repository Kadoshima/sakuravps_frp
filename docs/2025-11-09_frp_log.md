# FRP中継サーバ 現状メモ (2025-11-09)

目的
- Sakura VPS を中継点にして「外からの HTTP/WS リクエスト → 既存の常時アウトバウンド接続」で社内/宅内機器へ到達させる。

現状（サーバ側）
- Caddy: 80番で待受。ルートは200応答、サブドメインは frps:8080 へリバースプロキシ。
  - テンプレ: `terraform/templates/Caddyfile.tmpl`（http-only, auto_https off, `http://${domain}`, `http://*.${domain}`）
- frps: 稼働中。`--tls-only` で 7000/TCP を待受。vhostHTTPPort=8080、subdomainHost=kimulabfrp.jp。
  - テンプレ: `terraform/templates/frps.toml.tmpl`（bindPort=7000, vhostHTTPPort=8080, subdomainHost など）
  - Compose: `terraform/templates/docker-compose.yml.tmpl`（`--tls-only` を条件付けで付与）
- UFW: 80/443/7000/8080 開放（Terraformで投入）。
- DNS: Aレコード `kimulabfrp.jp -> 133.167.107.172` はOK。ワイルドカード（*.kimulabfrp.jp）は未確認。

不足しているもの（ゴール到達に必要）
- 各機器への frpc 常時接続設定（最重要）
  - v0.61.0 を各機器に導入し、VPSへアウトバウンドで常時接続。
  - プロキシ `type = "http"` に `subdomain = "<機器ID>"` を割当。
- ワイルドカードDNS（推奨）
  - `*.kimulabfrp.jp -> 133.167.107.172` を追加（個別レコード追加を省力化）。
- トークン整合
  - frps側 token と frpc 側 token を一致させる（Terraformの tfvars 設定と同一）。
- 検証フローの整備（frpsログ/HTTP/WS での簡易確認）

最短ルート（手順）
1) DNSを確認/整備
   - 既に apex A はOK。可能なら `*.kimulabfrp.jp` もAで追加。
2) 各機器に frpc を設置（v0.61.0）
   - frps は `--tls-only` のため、frpc は `protocol = "wss"` を使用。
3) 機器ごとの frpc.toml を作成
   ```toml
   # frpc.toml（例: ローカルHTTPが8080の機器）
   serverAddr = "kimulabfrp.jp"
   serverPort = 7000
   protocol   = "wss"

   [auth]
   method = "token"
   token  = "<Terraformで設定したトークン>"

   [[proxies]]
   name      = "device1"
   type      = "http"
   localPort = 8080
   subdomain = "device1"  # → http://device1.kimulabfrp.jp
   ```
4) frpc を起動/常駐
   - 手動: `./frpc -c frpc.toml`
   - systemd常駐（Linux）: `ExecStart=/usr/local/bin/frpc -c /etc/frp/frpc.toml`、`Restart=always`
5) 動作確認
   - frpsログ: `ssh ubuntu@133.167.107.172 "docker logs frps --since 5m | grep -i 'client login' -n"`
   - HTTP: `curl -I http://device1.kimulabfrp.jp`
   - WS（任意）: `wscat -c ws://device1.kimulabfrp.jp/<path>`（機器がWS提供時）

確認済みの事実（サーバ側）
- Caddy は 80/TCP で LISTEN。`Host: kimulabfrp.jp` で 200 を返却（ローカル到達で確認）。
- 未割当サブドメインは 404（正常）。
- frps は `--tls-only` で 7000/TCP LISTEN、vhostHTTPPort=8080。直近ログに unknown field エラーなし。

将来オプション
- エッジHTTPSが必要なら `caddy_mode = "dns01-cloudflare"` に切替（Cloudflare APIトークン要）。
- ダッシュボード(7500)は公開せず、必要時はSSHトンネル等で参照。

参考コマンド
- Caddy リロード: `ssh ubuntu@133.167.107.172 "docker exec caddy caddy reload --config /etc/caddy/Caddyfile"`
- ルート確認: `ssh ubuntu@133.167.107.172 "curl -s -o /dev/null -w '%{http_code}\n' -H 'Host: kimulabfrp.jp' http://127.0.0.1/"`
- サブドメイン404確認: `ssh ubuntu@133.167.107.172 "SUB=check$RANDOM; curl -s -o /dev/null -w '%{http_code}\n' -H \"Host: $SUB.kimulabfrp.jp\" http://127.0.0.1/"`
- frps 7000 LISTEN確認: `ssh ubuntu@133.167.107.172 "sudo ss -ltnp | grep ':7000 ' || sudo netstat -ltnp | grep ':7000 '"`

結論
- サーバ側（Caddy→frps）は目的に合致する状態まで整備済み。
- 残タスクは「各機器に frpc を入れて subdomain 付きHTTPプロキシを登録」＋「（推奨）*.kimulabfrp.jp のAレコード追加」。これがゴールへの最短ルート。

