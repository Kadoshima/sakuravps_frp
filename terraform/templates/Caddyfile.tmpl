%{ if caddy_mode == "http-only" ~}
{
  email ${acme_email}
%{ if enable_influxdb ~}
  acme_dns cloudflare {$CLOUDFLARE_API_TOKEN}
  debug
%{ endif ~}
}

# ルートドメインは直接応答（健康チェック・トップページ）
http://${domain} {
  respond "FRP edge is running (HTTP-only). Use subdomains (e.g. http://<id>.${domain})." 200
}

# サブドメインは frps:8080 へプロキシ
http://*.${domain} {
  reverse_proxy frps:8080 {
    header_up Host {host}
    header_up X-Forwarded-For {remote}
    header_up X-Forwarded-Proto http
  }
}
%{ if enable_influxdb ~}

# Influx (TLS, DNS-01 via Cloudflare)
https://influx.${domain} {
  tls {
    dns cloudflare {$CLOUDFLARE_API_TOKEN}
  }
  encode zstd gzip
  reverse_proxy influxdb:8086
}
%{ endif ~}
%{ else ~}
{
  email ${acme_email}
  acme_dns cloudflare {$CLOUDFLARE_API_TOKEN}
}

# ワイルドカード証明書でサブドメインを受け付ける（HTTPS明示）
https://*.${domain} {
  tls {
    dns cloudflare {$CLOUDFLARE_API_TOKEN}
  }
  encode zstd gzip
  reverse_proxy frps:8080 {
    header_up Host {host}
    header_up X-Forwarded-For {remote}
    header_up X-Forwarded-Proto {scheme}
  }
}

# 親ドメイン（HTTPS明示）
https://${domain} {
  encode zstd gzip
  reverse_proxy frps:8080 {
    header_up Host {host}
    header_up X-Forwarded-For {remote}
    header_up X-Forwarded-Proto {scheme}
  }
}
%{ if enable_influxdb ~}

https://influx.${domain} {
  encode zstd gzip
  reverse_proxy influxdb:8086
}
%{ endif ~}
%{ endif ~}
